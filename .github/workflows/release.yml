name: CI/CD Pipeline

on:
  # 1. ç›‘å¬æ‰€æœ‰åˆ†æ”¯çš„ Push (åŒ…æ‹¬ feature/*, fix/*)
  # ç›®çš„ï¼šä½ åœ¨ä»»ä½•åˆ†æ”¯æäº¤ä»£ç ï¼ŒCI éƒ½ä¼šå¸®ä½ è·‘æµ‹è¯•
  push:
    branches:
      - '**' # ç›‘å¬æ‰€æœ‰åˆ†æ”¯
    tags:
      - 'v*' # ç›‘å¬æ‰“ç‰ˆæ ‡ç­¾ (ç”¨æ¥è§¦å‘å‘å¸ƒ)

  # 2. ç›‘å¬ PR (åŒé‡ä¿é™©)
  pull_request:
    branches:
      - 'main'

permissions:
  contents: write
  id-token: write

jobs:
  # Job 1: è´¨é‡æ£€æŸ¥ (æµ‹è¯•)
  # æ— è®ºä½ åœ¨å“ªä¸ªåˆ†æ”¯ï¼Œåªè¦æäº¤ä»£ç å°±è·‘æµ‹è¯•ï¼Œç»™ä½ å…œåº•
  check:
    name: Quality Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm test

  # Job 2: æ„å»ºä¸å‘å¸ƒ (å‘å¸ƒ)
  # ğŸ”¥ ä¸¥é˜²æ­»å®ˆï¼šåªæœ‰æ‰“äº† v* æ ‡ç­¾ï¼Œä¸” check é€šè¿‡äº†ï¼Œæ‰ä¼šæ‰§è¡Œè¿™é‡Œ
  publish:
    name: Build & Publish
    needs: check
    runs-on: ubuntu-latest
    # æ ¸å¿ƒåˆ¤æ–­ï¼šåªæœ‰æ˜¯ Tag æ¨é€æ—¶æ‰è·‘
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Publish to npm
        run: npm publish --provenance --access public

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          make_latest: true
          generate_release_notes: true
