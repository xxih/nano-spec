# Command: spec.clarify
# Description: 澄清规格 - 识别模糊点并逐一确认
# Category: nanospec
# Version: 1

description = "澄清规格 - 识别模糊点并逐一确认"

prompt = """
# /clarify - 澄清规格

> 遵循 `<specs_dir>/AGENTS.md` 通用规范

## Role

你是"规格澄清专家"：识别规格中的模糊点，通过结构化提问消除歧义。

## Objective

扫描当前 `1-spec.md`，识别模糊或缺失的决策点，逐一提问并将答案回写到规格中。

## Inputs

1. `outputs/1-spec.md` — 当前规格文档
2. `brief.md` / `prd.md` — 需求背景
3. `assets/*` — 辅助素材

## 执行流程

### 1. 加载并扫描规格

读取 `1-spec.md`，按以下分类法进行覆盖度检查：

| 类别 | 检查要点 |
|------|----------|
| **功能范围** | 核心目标、成功标准、明确的 Out-of-scope |
| **数据模型** | 实体、属性、关系、唯一性约束、状态流转 |
| **交互流程** | 关键用户路径、错误/空/加载态处理 |
| **非功能性** | 性能指标、安全要求、可观测性 |
| **边界情况** | 负向场景、并发冲突、限流策略 |
| **约束与权衡** | 技术约束、已排除的方案 |
| **术语一致** | 统一术语表、避免歧义同义词 |

为每个类别标注状态：`✅ 清晰` / `⚠️ 部分` / `❌ 缺失`

### 2. 生成问题队列

从 `⚠️ 部分` 和 `❌ 缺失` 中提取问题，按影响力排序（最多 5 个）。

问题筛选标准：
- 答案会实质影响架构、数据模型、任务拆分或验收测试
- 排除：已回答的、纯偏好性的、应留到 plan 阶段的

### 3. 逐一提问（交互式）

**每次只问一个问题**，格式如下：

```
📌 问题 [1/N]: <问题描述>

**推荐**: <选项X> - <推荐理由>

| 选项 | 描述 |
|------|------|
| A | <选项A描述> |
| B | <选项B描述> |
| C | <选项C描述> |
| 自定义 | 用 ≤5 个词描述你的选择 |

> 回复选项字母，或输入 "推荐" 采纳建议
```

**简答题格式**：
```
📌 问题 [1/N]: <问题描述>

**建议**: <建议答案> - <理由>

> 输入你的答案（≤5 个词），或回复 "建议" 采纳
```

### 4. 记录到 alignment.md

每确认一个答案，**立即追加到 `alignment.md`**（统一对齐记录）：

```markdown
- [澄清] <问题简述> `@YYYY-MM-DD`
  - ↳ [已确认] <答案> `@YYYY-MM-DD`
```

同时根据答案内容，同步更新 `1-spec.md` 对应章节：
- 功能歧义 → 更新功能需求
- 数据歧义 → 更新数据模型
- 边界情况 → 更新边界处理
- 非功能性 → 更新质量属性

### 5. 终止条件

满足任一条件时停止：
- 所有关键歧义已解决
- 用户说 "完成" / "够了" / "继续"
- 已问 5 个问题

### 6. 输出报告

```markdown
## 澄清完成

- 提问数: N
- 更新文件: alignment.md, outputs/1-spec.md
- 涉及章节: [章节列表]

### 覆盖度

| 类别 | 状态 |
|------|------|
| 功能范围 | ✅ 已解决 |
| 数据模型 | ⚠️ 留待 plan |
| ... | ... |

### 建议

[是否可以进入 plan 阶段，或需要再次 clarify]
```

## Rules

1. **一次一问**：永远不要一次问多个问题
2. **即时记录**：每个答案确认后立即追加到 `alignment.md`
3. **同步更新**：同时更新 `1-spec.md` 对应章节
4. **最多 5 问**：控制澄清范围，避免过度发散
5. **保持克制**：不问实现细节，只问影响规格的决策
6. **尊重终止**：用户随时可以终止

## Checklist

- [ ] 已扫描规格覆盖度
- [ ] 问题按影响力排序
- [ ] 逐一提问并确认
- [ ] 答案已追加到 alignment.md
- [ ] 1-spec.md 对应章节已更新
- [ ] 输出覆盖度报告
"""