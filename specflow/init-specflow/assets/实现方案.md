# SpecFlow CLI å®ç°æ–¹æ¡ˆ

> æŠ€æœ¯æ ˆï¼šTypeScript + Node.jsï¼ˆæç®€ç‰ˆï¼Œç›®æ ‡ ~300 è¡Œï¼‰

---

## 1. é¡¹ç›®ç»“æ„

```
specflow-cli/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # CLI å…¥å£
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ init.ts           # specflow init
â”‚   â”‚   â””â”€â”€ new.ts            # specflow new
â”‚   â”œâ”€â”€ adapters/             # AI é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ index.ts          # é€‚é…å™¨æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ cursor.ts         # Cursor å‘½ä»¤ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ claude.ts         # Claude å‘½ä»¤ç”Ÿæˆï¼ˆå¾…å®ç°ï¼‰
â”‚   â””â”€â”€ templates/            # å†…ç½®æ¨¡æ¿
â”‚       â”œâ”€â”€ AGENTS.md
â”‚       â”œâ”€â”€ commands/
â”‚       â”‚   â”œâ”€â”€ flow.1-spec.md
â”‚       â”‚   â”œâ”€â”€ flow.2-plan.md
â”‚       â”‚   â”œâ”€â”€ flow.3-execute.md
â”‚       â”‚   â”œâ”€â”€ flow.accept.md
â”‚       â”‚   â”œâ”€â”€ flow.align.md
â”‚       â”‚   â””â”€â”€ flow.summary.md
â”‚       â””â”€â”€ outputs/
â”‚           â”œâ”€â”€ 1-spec.md
â”‚           â”œâ”€â”€ 2-plan.md
â”‚           â”œâ”€â”€ 3-tasks.md
â”‚           â”œâ”€â”€ acceptance.md
â”‚           â”œâ”€â”€ alignment.md
â”‚           â””â”€â”€ summary.md
â””â”€â”€ bin/
    â””â”€â”€ specflow.js
```

---

## 2. CLI å…¥å£ (`src/index.ts`)

```typescript
#!/usr/bin/env node

import { Command } from 'commander';
import { init } from './commands/init';
import { newTask } from './commands/new';

const program = new Command();

program
  .name('specflow')
  .description('SpecFlow - Spec é©±åŠ¨å¼€å‘å·¥ä½œæµ')
  .version('1.0.0');

// specflow init
program
  .command('init')
  .description('åˆå§‹åŒ– SpecFlow é¡¹ç›®ç»“æ„')
  .option('--ai <tool>', 'AI å·¥å…·ç±»å‹', 'cursor')
  .option('-f, --force', 'å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶')
  .action((options) => init(options));

// specflow new
program
  .command('new [name]')
  .description('åˆ›å»ºæ–°çš„ä»»åŠ¡ç›®å½•')
  .action((name) => newTask(name));

program.parse();
```

---

## 3. init å‘½ä»¤ (`src/commands/init.ts`)

```typescript
import { existsSync, mkdirSync, writeFileSync, cpSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { getAdapter } from '../adapters';

interface InitOptions {
  ai: string;
  force?: boolean;
}

export async function init(options: InitOptions): Promise<void> {
  const cwd = process.cwd();
  const specflowDir = join(cwd, 'specflow');
  const templatesDir = join(specflowDir, 'templates');

  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  if (existsSync(specflowDir) && !options.force) {
    console.log('âš ï¸  specflow/ ç›®å½•å·²å­˜åœ¨ï¼Œä½¿ç”¨ --force å¼ºåˆ¶è¦†ç›–');
    return;
  }

  // è·å– AI é€‚é…å™¨
  const adapter = getAdapter(options.ai);
  if (!adapter) {
    console.log(`âŒ ä¸æ”¯æŒçš„ AI å·¥å…·: ${options.ai}`);
    console.log('   æ”¯æŒ: cursor, claude');
    return;
  }

  // åˆ›å»ºç›®å½•ç»“æ„
  mkdirSync(templatesDir, { recursive: true });

  // å¤åˆ¶å†…ç½®æ¨¡æ¿
  const __dirname = dirname(fileURLToPath(import.meta.url));
  const builtinTemplates = join(__dirname, '../templates');

  // å¤åˆ¶ AGENTS.md
  copyFile(
    join(builtinTemplates, 'AGENTS.md'),
    join(specflowDir, 'AGENTS.md')
  );
  console.log('âœ“ åˆ›å»º specflow/AGENTS.md');

  // å¤åˆ¶äº§å‡ºç‰©æ¨¡æ¿
  const outputTemplates = [
    '1-spec.md', '2-plan.md', '3-tasks.md',
    'acceptance.md', 'alignment.md', 'summary.md'
  ];
  for (const template of outputTemplates) {
    copyFile(
      join(builtinTemplates, 'outputs', template),
      join(templatesDir, template)
    );
  }
  console.log('âœ“ åˆ›å»º specflow/templates/ (6 ä¸ªæ¨¡æ¿)');

  // ç”Ÿæˆ AI å‘½ä»¤æ–‡ä»¶
  adapter.generateCommands(cwd, builtinTemplates);
  console.log(`âœ“ åˆ›å»º ${adapter.commandsDir} (6 ä¸ªå‘½ä»¤)`);

  console.log('\nğŸ‰ SpecFlow åˆå§‹åŒ–å®Œæˆï¼');
  console.log('\nä¸‹ä¸€æ­¥ï¼š');
  console.log('  1. specflow new "ä»»åŠ¡åç§°"  åˆ›å»ºä»»åŠ¡ç›®å½•');
  console.log('  2. ç¼–è¾‘ brief.md æè¿°éœ€æ±‚');
  console.log('  3. ä½¿ç”¨ /flow.1-spec å¼€å§‹è§„æ ¼æ’°å†™');
}

function copyFile(src: string, dest: string): void {
  const dir = dirname(dest);
  if (!existsSync(dir)) {
    mkdirSync(dir, { recursive: true });
  }
  if (existsSync(src)) {
    cpSync(src, dest);
  }
}
```

---

## 4. new å‘½ä»¤ (`src/commands/new.ts`)

```typescript
import { existsSync, mkdirSync, writeFileSync } from 'fs';
import { join } from 'path';

export async function newTask(name?: string): Promise<void> {
  const cwd = process.cwd();
  const specflowDir = join(cwd, 'specflow');

  // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
  if (!existsSync(specflowDir)) {
    console.log('âŒ è¯·å…ˆè¿è¡Œ specflow init åˆå§‹åŒ–é¡¹ç›®');
    return;
  }

  // ç”Ÿæˆç›®å½•åï¼šYYYYMMDD-åç§°
  const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const taskName = name || 'å¾…å‘½å';
  const dirName = `${date}-${taskName}`;
  const taskDir = join(specflowDir, dirName);

  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  if (existsSync(taskDir)) {
    console.log(`âš ï¸  ç›®å½•å·²å­˜åœ¨: ${dirName}`);
    return;
  }

  // åˆ›å»ºç›®å½•ç»“æ„
  mkdirSync(join(taskDir, 'assets'), { recursive: true });
  mkdirSync(join(taskDir, 'outputs'), { recursive: true });

  // åˆ›å»ºç©ºçš„ brief.md
  writeFileSync(
    join(taskDir, 'brief.md'),
    `# ${taskName}\n\n<!-- åœ¨æ­¤æè¿°éœ€æ±‚ -->\n`,
    'utf-8'
  );

  console.log(`âœ“ åˆ›å»ºä»»åŠ¡ç›®å½•: specflow/${dirName}/`);
  console.log('  â”œâ”€â”€ brief.md');
  console.log('  â”œâ”€â”€ assets/');
  console.log('  â””â”€â”€ outputs/');
  console.log('\nä¸‹ä¸€æ­¥ï¼šç¼–è¾‘ brief.md æè¿°éœ€æ±‚ï¼Œç„¶åä½¿ç”¨ /flow.1-spec');
}
```

---

## 5. AI é€‚é…å™¨

### 5.1 é€‚é…å™¨æ¥å£ (`src/adapters/index.ts`)

```typescript
export interface AIAdapter {
  name: string;
  commandsDir: string;
  generateCommands(cwd: string, templatesDir: string): void;
}

import { cursorAdapter } from './cursor';
import { claudeAdapter } from './claude';

const adapters: Record<string, AIAdapter> = {
  cursor: cursorAdapter,
  claude: claudeAdapter,
};

export function getAdapter(name: string): AIAdapter | null {
  return adapters[name] || null;
}

export function listAdapters(): string[] {
  return Object.keys(adapters);
}
```

### 5.2 Cursor é€‚é…å™¨ (`src/adapters/cursor.ts`)

```typescript
import { existsSync, mkdirSync, cpSync } from 'fs';
import { join } from 'path';
import type { AIAdapter } from './index';

export const cursorAdapter: AIAdapter = {
  name: 'cursor',
  commandsDir: '.cursor/commands/',

  generateCommands(cwd: string, templatesDir: string): void {
    const commandsDir = join(cwd, '.cursor', 'commands');
    mkdirSync(commandsDir, { recursive: true });

    const commands = [
      'flow.1-spec.md',
      'flow.2-plan.md',
      'flow.3-execute.md',
      'flow.accept.md',
      'flow.align.md',
      'flow.summary.md',
    ];

    for (const cmd of commands) {
      const src = join(templatesDir, 'commands', cmd);
      const dest = join(commandsDir, cmd);
      if (existsSync(src)) {
        cpSync(src, dest);
      }
    }
  },
};
```

### 5.3 Claude é€‚é…å™¨ (`src/adapters/claude.ts`)

```typescript
import { existsSync, mkdirSync, readFileSync, writeFileSync } from 'fs';
import { join } from 'path';
import type { AIAdapter } from './index';

export const claudeAdapter: AIAdapter = {
  name: 'claude',
  commandsDir: '.claude/commands/',

  generateCommands(cwd: string, templatesDir: string): void {
    const commandsDir = join(cwd, '.claude', 'commands');
    mkdirSync(commandsDir, { recursive: true });

    // TODO: å‚è€ƒ spec-kit å®ç° Claude å‘½ä»¤æ ¼å¼è½¬æ¢
    // Claude å‘½ä»¤æ ¼å¼å¯èƒ½ä¸ Cursor ä¸åŒï¼Œéœ€è¦é€‚é…

    const commands = [
      'flow.1-spec.md',
      'flow.2-plan.md',
      'flow.3-execute.md',
      'flow.accept.md',
      'flow.align.md',
      'flow.summary.md',
    ];

    for (const cmd of commands) {
      const src = join(templatesDir, 'commands', cmd);
      const dest = join(commandsDir, cmd);
      if (existsSync(src)) {
        // è¯»å–å¹¶è½¬æ¢æ ¼å¼ï¼ˆå¦‚éœ€è¦ï¼‰
        const content = readFileSync(src, 'utf-8');
        const converted = convertToClaude(content);
        writeFileSync(dest, converted, 'utf-8');
      }
    }
  },
};

function convertToClaude(content: string): string {
  // TODO: å®ç° Cursor â†’ Claude å‘½ä»¤æ ¼å¼è½¬æ¢
  // å‚è€ƒ spec-kit ä»£ç ä»“åº“
  return content;
}
```

---

## 6. é…ç½®æ–‡ä»¶

### 6.1 package.json

```json
{
  "name": "specflow-cli",
  "version": "1.0.0",
  "description": "SpecFlow - Spec é©±åŠ¨å¼€å‘å·¥ä½œæµ",
  "type": "module",
  "main": "dist/index.js",
  "bin": {
    "specflow": "./bin/specflow.js"
  },
  "scripts": {
    "build": "tsc",
    "dev": "tsx src/index.ts"
  },
  "dependencies": {
    "commander": "^12.0.0"
  },
  "devDependencies": {
    "@types/node": "^22.0.0",
    "typescript": "^5.5.0",
    "tsx": "^4.0.0"
  },
  "engines": {
    "node": ">=18"
  }
}
```

### 6.2 tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "dist",
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "declaration": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 6.3 bin/specflow.js

```javascript
#!/usr/bin/env node
import '../dist/index.js';
```

---

## 7. ä½¿ç”¨ç¤ºä¾‹

```bash
# å®‰è£…ï¼ˆå…¨å±€ï¼‰
npm install -g specflow-cli

# åˆå§‹åŒ–é¡¹ç›®ï¼ˆé»˜è®¤ Cursorï¼‰
specflow init

# æŒ‡å®š AI å·¥å…·
specflow init --ai claude

# å¼ºåˆ¶è¦†ç›–
specflow init --force

# åˆ›å»ºä»»åŠ¡ç›®å½•
specflow new                    # â†’ specflow/20260119-å¾…å‘½å/
specflow new "ç”¨æˆ·è®¤è¯åŠŸèƒ½"      # â†’ specflow/20260119-ç”¨æˆ·è®¤è¯åŠŸèƒ½/
```

---

## 8. å†…ç½®æ¨¡æ¿æ¸…å•

### 8.1 AGENTS.md

åŸºäºç°æœ‰ `specflow/AGENTS.md`ï¼ŒåŒ…å«ï¼š
- å˜é‡å®šä¹‰
- å¼ºåˆ¶è§„åˆ™
- ç›®å½•ç»“æ„
- è¾“å…¥ä¼˜å…ˆçº§
- è¾“å‡ºæ¨¡æ¿
- å˜æ›´ä¼ æ’­
- ä»»åŠ¡çŠ¶æ€
- å‘½ä»¤æ¦‚è§ˆ
- å®šåˆ¶æŒ‡å—

### 8.2 æ–œæ å‘½ä»¤ï¼ˆ6 ä¸ªï¼‰

| æ–‡ä»¶ | èŒè´£ |
| --- | --- |
| `flow.1-spec.md` | è§„æ ¼æ’°å†™ |
| `flow.2-plan.md` | æ–¹æ¡ˆ + ä»»åŠ¡æ‹†è§£ |
| `flow.3-execute.md` | æ‰§è¡Œäº¤ä»˜ |
| `flow.accept.md` | éªŒæ”¶ç”¨ä¾‹ |
| `flow.align.md` | å¯¹é½çº å |
| `flow.summary.md` | æ€»ç»“æ²‰æ·€ |

### 8.3 äº§å‡ºç‰©æ¨¡æ¿ï¼ˆ6 ä¸ªï¼‰

| æ–‡ä»¶ | ç”¨é€” |
| --- | --- |
| `1-spec.md` | è§„æ ¼æ–‡æ¡£ç»“æ„ |
| `2-plan.md` | æŠ€æœ¯æ–¹æ¡ˆç»“æ„ |
| `3-tasks.md` | ä»»åŠ¡æ¸…å•æ ¼å¼ |
| `acceptance.md` | éªŒæ”¶ç”¨ä¾‹æ ¼å¼ |
| `alignment.md` | å¯¹é½è®°å½•æ ¼å¼ |
| `summary.md` | æ€»ç»“æ–‡æ¡£æ ¼å¼ |

---

## 9. åç»­è¿­ä»£

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | è¯´æ˜ |
| --- | --- | --- |
| P1 | init + new | æ ¸å¿ƒå‘½ä»¤ |
| P1 | Cursor é€‚é…å™¨ | é»˜è®¤æ”¯æŒ |
| P2 | Claude é€‚é…å™¨ | å‚è€ƒ spec-kit |
| P2 | GitHub Copilot é€‚é…å™¨ | å¾…è°ƒç ”å‘½ä»¤æ ¼å¼ |
| P3 | æ¨¡æ¿å˜é‡æ›¿æ¢ | æ”¯æŒ `{{date}}` ç­‰ |
| P3 | é…ç½®æ–‡ä»¶ | å¯é€‰çš„ `.specflowrc` |
